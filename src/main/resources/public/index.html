<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/codemirror.css">
  <script src="js/codemirror.js"></script>
  <script src="js/groovy.js"></script>
  <script src="js/matchbrackets.js"></script>
  <script src="js/axios.min.js"></script>
  <script src="js/filesaver.js"></script>
  <title>Zefaker Web</title>
</head>

<body>
  <h1>Zefaker Web</h1>

  <form id="zefaker-form" method="post" action="/generate">
    <div id="zefaker-editor">
      <textarea id="zefaker-editor-textarea" name="code">
// Welcome to zefaker!

// This is an example, you can put your code here
import java.util.concurrent.atomic.AtomicInteger

autoIncrementID = new AtomicInteger(0)

id        = column(index= 0, name= "id")
firstName = column(index= 1, name= "firstName")
lastName  = column(index= 2, name= "lastName")
age       = column(index= 3, name= "age")
userStatus= column(index= 4, name= "userStatus")

generateFrom([
  (id):{ faker -> autoIncrementID.incrementAndGet() },
    (firstName): { faker -> faker.name().firstName() },
    (lastName): { faker -> faker.name().lastName() },
    (age): { faker -> faker.number().numberBetween(18, 70) },
    (userStatus): { faker -> faker.options().option("active", "unverified account", "disabled:flagged") }
])
      </textarea>
    </div>

    <div class="output-options">
      <div class="form">
        <fieldset name="general-options">
          <label for="fileName">FileName</label>
          <input type="text" name="fileName" placeholder="fileName">
  
          <label for="format">File Type</label>
          <select name="format" id="">
            <option value="">Please select output format</option>
            <option value="sql">SQL</option>
            <option value="csv">CSV</option>
            <option value="json">JSON</option>
            <option value="jsonl">JSON Lines</option>
            <option value="excel">Excel</option>
          </select>
  
          <label for="rows">Number of Records</label>
          <input type="number" name="rows" placeholder="Number of records to generate">
        </fieldset>

        <fieldset>
          <legend>SQL Specific options</legend>

          <label for="table">Tablename</label>
          <input type="text" name="table" placeholder="Choose table name for SQL output">

          <label for="sqlquote">Quote Columns as</label>
          <select name="sqlquote" id="">
            <option value="">Please select SQL Quote Style</option>
            <option value="none">None</option>
            <option value="postgres">Postgres <code>"column"</code></option>
            <option value="mssql">SQL Server <code>[column]</code></option>
            <option value="mysql">MySQL <code>`column`</code></option>
          </select>
        </fieldset>

        <fieldset>
          <legend>Excel Specific options</legend>
          <label for="sheet">Sheet Name</label>
          <input type="text" name="sheet" placeholder="Select Sheet Name for Excel files">
        </fieldset>
      </div>

      <button>Generate File</button>
    </div>
  </form>

  <script>
    var editor = CodeMirror.fromTextArea(document.getElementById("zefaker-editor-textarea"), {
      lineNumbers: true,
      matchBrackets: true,
      mode: "text/x-groovy"
    });

    

    document.getElementById('zefaker-form').addEventListener("submit", (event) => {
      event.preventDefault();
      let formData = {
        fileName: "test.sql",
        code: editor.getValue(),
        format: "sql",
        sheet: "Sheet 1",
        sqlquote: "postgres",
        rows: 100,
        table: 'data-thing',
      }

      const url = "/generate";

      axios({
            method: 'post',
            type: 'json',
            url: url,
            data: JSON.stringify(formData),
            responseType: 'blob',
            headers: {
              'Content-Type': 'application/json',
              'Accept': '*/*'
            }
        })
        .then(function checkStatus(response) {
            if (response.status != 200) {
                let error = new Error(response.statusText);
                error.response = response;
                throw error;
            }
            return response;    
        })
        .then(response => saveAs(response.data, formData.fileName))
        // parse the JSON response for OK responses
        //.then(response => response.json())
        //.then(json => successCallback(json))
        .catch(err => {
            console.log(err)
            // General conenction error
            if ('response' in err) {
                const response = err.response;
                if (response.status === 409) {
                    return Promise.resolve({
                        message: 'File uploaded already exists on the server',
                        fileAlreadyExists: true
                    });
                }
            }
        });
        
        return false;
      });
  </script>
</body>

</html>